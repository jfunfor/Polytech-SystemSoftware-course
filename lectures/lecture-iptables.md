# Межсетевой экран

iptables - инструмент администрирования фильтра пакетов IPv4 и NAT

**Iptables** используется для установки, настройки и просмотра таблиц правил фильтрации IP-пакетов в ядре Linux.

Каждая таблица содержит несколько предопределённых цепочек и может содержать цепочки, определённые пользователем. Каждая цепочка - это список правил, которые могут 
воздействовать на множество пакетов. Каждое правило определяет, какие действие произвести с пакетами, на которые оно действует. Эти действия называются целью, целью может 
быть и переход на другую (определённую пользователем) цепочку в этой же таблице.

---

Правило брандмауэра (межсетевого экрана) определяет критерии для пакета и цели. Если пакет не попадает под действие правила, проверяется следующее правило в цепочке; если 
попадает - проверяется правило, указанное в цели, которая может быть именем новой цепочки или одно из специальных целей: _ACCEPT_, _DROP_, _QUEUE_ или _RETURN_.

---

# Таблицы (tables)
Существует три независимых таблицы (какие именно таблицы присутствуют в данный момент -- зависит от конфигурации ядра и наличия его модулей).

iptables содержит в себе пять таблиц:
1. `raw` используется для создания исключений в слежении за соединениями. Данная таблица имеет наивысший приоритет, так что это отличный способ для создания исключений в 
правилах.
2. `filter` - таблица по умолчанию, в которой содержатся правила, обычно относящиеся к фаерволу.
3. `nat` используется для технологии механизма преобразования сетевых адресов (NAT)
4. `mangle` используется для специальных изменений пакетов

В большинстве случаев используются таблицы filter и nat. Остальные таблицы предназначены для копмлексной конфигурации с несколькими роутерами и сложными маршрутными 
решениями.

# Цепочки (chains)
Таблицы состоят из цепочек, которые представляют собой упорядоченный список правил. Таблица `filter`, к примеру, по умолчанию содержит в себе три цепочки: `INPUT` (для 
входящих пакетов), `OUTPUT` (для исходящих пакетов - сгенерированных в локальной системе) и `FORWARD` (для проходящих пакетов).

По умолчанию никакие цепочки не содержат никаких правил. Администратор сам решает какие цепочки и как ему использовать. Цепочки изначально содержат политику, которая 
назначена на `ACCEPT`, что означает прохождение всех соединений. Можно сбросить ее на `DROP` и тогда ни одно соединение не будет проходить. Таким образом, можно настроить 
фаервол работать исключительно с теми соединениями, которые требуются для решения текущих задач. Так поступают, в основном, из соображений безопасности. На Arch Wiki есть 
прекрасная [статья](https://wiki.archlinux.org/title/Simple_stateful_firewall) про конфигурацию простого фаервола. Автор данной теоретической заметки рекомендует к 
прочтению!

# Правила (rules)
Фильтрация пакетов основана на правилах, которые задаются списком совпадений (matches) - условий, которым должен соответствовать пакет, чтобы правила были применены к нему.

# Базовые команды iptables
#### Просмотр текущих правил
Чтобы просмотреть текущие правила, используйте команду `iptables -L`. Это покажет все правила в таблице filter. Чтобы просмотреть правила в другой таблице, используйте флаг 
`-t`, например, `iptables -t nat -L`.

#### Добавление новых правил

Чтобы добавить новое правило, используйте команду `iptables -A`. Например, чтобы заблокировать весь входящий трафик от IP-адреса 192.168.0.100, вы можете использовать 
следующую команду:

`iptables -A INPUT -s 192.168.0.100 -j DROP` 

В этой команде `-A INPUT` добавляет новое правило в цепочку INPUT, `-s 192.168.0.100` определяет исходный IP-адрес, а `-j DROP` указывает, что все пакеты, соответствующие 
этому правилу, должны быть отброшены.

#### Удаление правил
Чтобы удалить правило, вам нужно знать его номер в цепочке. Вы можете узнать номера правил, используя команду `iptables -L --line-numbers`. Затем вы можете удалить правило, 
используя команду `iptables -D` и номер правила. Например, чтобы удалить первое правило в цепочке INPUT, вы можете использовать следующую команду:

`iptables -D INPUT 1` 

#### Изменение политики по умолчанию
Вы можете изменить политику по умолчанию для цепочки, используя команду `iptables -P`. Например, чтобы отклонить все входящие пакеты по умолчанию, вы можете использовать 
следующую команду:

`iptables -P INPUT DROP` 

#### Сохранение и восстановление правил
По умолчанию, правила iptables не сохраняются после перезагрузки системы. Чтобы сохранить текущие правила, вы можете использовать команду `iptables-save`. Это выведет 
текущие правила в формате, который можно использовать для восстановления с помощью команды `iptables-restore`.

`iptables-save > /path/to/iptables/rules` 

Затем, чтобы восстановить правила, вы можете использовать следующую команду:

`iptables-restore < /path/to/iptables/rules`

# Примеры использования iptables

| Задача                                                 | Пример команды                                               | Заметка                                                                                    
|
| ------------------------------------------------------ | ------------------------------------------------------------ | 
------------------------------------------------------------------------------------------ |
| Блокировка IP-адреса                                   | `iptables -A INPUT -s 192.168.0.100 -j DROP`                 |                                                                                            
|
| Открытие порта для входящего tcp-трафика через порт 80 | `iptables -A INPUT -p tcp --dport 80 -j ACCEPT`              | `-j ACCEPT` указывает, что все пакеты, 
соответствующие этому правилу, должны быть приняты. |
| Запретить весь входящий ICMP-трафик                    | `iptables -A INPUT --proto icmp -j DROP`                     |                                                                                            
|
| Запретить отвечать на только на ICMP-echo запросы      | `iptables -A INPUT -p icmp --icmp-type echo-request -j DROP` | Остальные icmp-запросы будут проходить                                                     
|

# Расширенное использование Iptables

#### Логирование

Iptables предоставляет возможность логирования пакетов, что может быть полезно для отладки и мониторинга. Для включения логирования используйте цель `LOG`. Например, чтобы 
залогировать все отброшенные пакеты, можно использовать следующую команду:

`iptables -A INPUT -j LOG --log-prefix "Dropped Packet: " iptables -A INPUT -j DROP` 

Здесь `--log-prefix "Dropped Packet: "` добавляет указанный префикс к каждому лог-сообщению, что упрощает фильтрацию и анализ логов.

#### Создание пользовательских цепочек

Iptables позволяет создавать пользовательские цепочки для более гибкого управления правилами. Например, вы можете создать цепочку для обработки всего трафика от 
определенного IP-адреса:

`iptables -N MY_CHAIN iptables -A MY_CHAIN -s 192.168.0.100 -j DROP iptables -A INPUT -j MY_CHAIN` 

В этом примере команда `-N MY_CHAIN` создает новую цепочку с именем MY_CHAIN. Затем добавляется правило, которое отбрасывает все пакеты от 192.168.0.100. Наконец, цепочка 
MY_CHAIN добавляется в цепочку INPUT, что означает, что все входящие пакеты будут также проходить через цепочку MY_CHAIN.

#### Использование состояний пакетов

Iptables может отслеживать состояние пакетов, что позволяет создавать более сложные правила. Например, вы можете разрешить только входящие пакеты, которые являются частью 
уже установленного соединения:

`iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT` 

В этом примере `-m state` указывает на использование модуля состояний, а `--state ESTABLISHED,RELATED` указывает, что правило применяется только к пакетам, которые являются 
частью уже установленного или связанного соединения.

#### Использование Iptables для создания VPN

Iptables также может быть использован для создания VPN (Virtual Private Network). Это может быть полезно для создания безопасного соединения между удаленными системами. 
Например, вы можете использовать iptables для настройки IPsec VPN, используя модуль "policy" для определения правил обработки трафика.

`iptables -A INPUT -m policy --dir in --pol ipsec -j ACCEPT iptables -A OUTPUT -m policy --dir out --pol ipsec -j ACCEPT` 

В этом примере `-m policy` указывает на использование модуля "policy", `--dir in` и `--dir out` указывают на направление трафика, а `--pol ipsec` указывает на использование 
IPsec политики.

#### Использование Iptables для ограничения скорости

Iptables также может быть использован для ограничения скорости сетевого трафика, что может быть полезно для управления пропускной способностью. Для этого можно использовать 
модуль "limit". Например, вы можете ограничить количество новых SSH-соединений до 3 в минуту следующим образом:

`iptables -A INPUT -p tcp --dport 22 -m state --state NEW -m limit --limit 3/min -j ACCEPT` 

В этом примере `-m limit --limit 3/min` указывает на ограничение скорости, а остальная часть команды определяет, что она применяется к новым SSH-соединениям.

#### Использование Iptables для редиректа трафика

Iptables может быть использован для редиректа трафика, что может быть полезно для перенаправления трафика на другой порт или сервер. Например, вы можете перенаправить весь 
входящий трафик на порт 80 на порт 8080 следующим образом:

`iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080` 

В этом примере `-t nat` указывает на использование таблицы NAT, `-A PREROUTING` добавляет правило в цепочку PREROUTING, `--dport 80` указывает на исходный порт, а 
`--to-port 8080` указывает на порт назначения.

Iptables - это мощный и гибкий инструмент, который может быть использован для решения множества задач управления сетью. Однако, как и любой мощный инструмент, он требует 
тщательного понимания и практики для эффективного использования.
