Основы мониторинга в LINUX
Мониторинг — это процесс наблюдения за состоянием и производительностью системы в реальном времени или в виде логов. Его основная цель — обнаруживать сбои, узкие места и потенциальные проблемы до того, как они приведут к серьёзным последствиям.
Зачем нужен мониторинг:
-	Раннее выявление проблем.
-	Оптимизация производительности.
-	Обеспечение безопасности.
-	Анализ нагрузки и масштабирование.
-	Аудит и расследование инцидентов.

/
Классификация мониторингов по назначению
1. Мониторинг доступности (Availability Monitoring)
Цель: Проверка, доступна ли система, приложение или сервис. 
Методы: Периодическая отправка запросов (ping, HTTP-запросы, TCP-соединения). Примеры инструментов: ping, curl, check_http (из Nagios), uptime.

2. Мониторинг производительности (Performance Monitoring)
Цель: Измерение и анализ использования ресурсов: CPU, RAM, диск, сеть. Параметры: нагрузка, задержки, скорость I/O, использование ресурсов. Инструменты: top, htop, vmstat, iostat, iftop, nmon.

3. Мониторинг логов (Log Monitoring)
Цель: Анализ логов на предмет ошибок, предупреждений, аномалий. 
Источники: /var/log/syslog, /var/log/messages, /var/log/auth.log, nginx logs и др. Инструменты: logwatch, logrotate, journalctl, ELK-стек (Elasticsearch + Logstash + Kibana), rsyslog.

4. Мониторинг приложений (Application Monitoring)
Цель: Контроль работоспособности конкретных сервисов (например, nginx, PostgreSQL, Docker). 
Параметры: время ответа, количество ошибок, использование API. Инструменты: systemctl, monit, pm2, Nagios, Prometheus + exporters.

5. Мониторинг безопасности (Security Monitoring)
Цель: Выявление вторжений, утечек, несанкционированного доступа. 
Источники: лог-файлы, аудиты, firewall-логи. 
Инструменты: fail2ban, auditd, iptables + ulogd, OSSEC, AIDE, Wazuh.

II. Классификация по методу сбора данных
1. Активный мониторинг (Active Monitoring)
Принцип: Мониторинговая система инициирует запрос (ping, curl, telnet). 
Плюсы: Быстрое обнаружение сбоев, простота настройки. 
Минусы: Может повышать нагрузку. 
Примеры: ping, check_http, check_tcp.

2. Пассивный мониторинг (Passive Monitoring)
Принцип: Система сама отправляет данные или события на мониторинговый сервер. Плюсы: Меньшая нагрузка, детализированные логи. 
Минусы: Сложнее настроить, требует агентской инфраструктуры. 
Примеры: syslog, SNMP traps, Prometheus exporters, push-уведомления.

III. Классификация по уровню анализа
1. Мониторинг на уровне операционной системы
Что отслеживается: процессы, ресурсы, загрузка, пользователи, службы. Инструменты: top, vmstat, ps, systemctl, uptime.

2. Мониторинг на уровне приложений
Что отслеживается: внутренние метрики — запросы, ошибки, логи, работа API. Инструменты: monit, Prometheus exporters, Jaeger, New Relic.

3. Мониторинг на уровне сети
Что отслеживается: трафик, соединения, потери пакетов, маршруты. Инструменты: tcpdump, iftop, ss, netstat, nload.

IV. Классификация по частоте и режиму
1. Режим реального времени (Real-time Monitoring)
Примеры: htop, nmon, glances, iftop — данные постоянно обновляются. Плюсы: Немедленная реакция. Минусы: Нагрузка на систему, не всегда подходит для логирования.

2. Мониторинг по расписанию / периодический
Примеры: cron + sar, iostat, atop, Prometheus (по интервалу scrape). Плюсы: Подходит для долгосрочного анализа. Минусы: Может не зафиксировать кратковременные проблемы.

V. Интеграционный мониторинг и APM (Application Performance Management)
Что это: Комплексные платформы, собирающие данные с разных уровней (инфраструктура, сеть, приложения, логи, пользователи). 
Примеры систем:
Prometheus + Grafana
Zabbix
Nagios
Datadog
New Relic
Elastic Stack (ELK/EFK)

/
Метрика CPU — это количественное измерение определённого аспекта работы процессора (центрального процессора, Central Processing Unit). Такие метрики помогают понять, насколько эффективно используется CPU, как он справляется с нагрузкой, и есть ли проблемы, мешающие нормальной работе системы.
Существует несколько видов основных метрик CPU.
1.	 Load Average (средняя нагрузка)
Описание:
Load Average — это количество процессов в состоянии ожидания (ready/runnable) за последние 1, 5 и 15 минут.
Пример вывода команды uptime:
lua
load average: 0.23, 0.34, 0.29
Интерпретация:
Значения сравниваются с количеством ядер CPU.
Если у вас 4 ядра и load average = 4.0, то CPU загружен на 100%.
Значение выше количества ядер говорит о перегрузке.
Инструменты: uptime / top/ w

2. CPU Utilization (использование CPU)
Описание:
Отражает, как используется процессор: сколько времени он тратит на выполнение задач, ожидание ввода-вывода, простои и т.д.
Типы загрузки:
-	us (user) - Процессы пользователя
-	sy (system) - Ядро (системные вызовы, драйверы)
-	ni (nice) - Процессы с изменённым приоритетом
-	id (idle) - Простой процессора
-	wa (iowait) - Ожидание операций ввода-вывода
-	hi (hardware irq) - Аппаратные прерывания
-	si (software irq) - Программные прерывания
-	st (steal) - Время, "украденное" гипервизором (VM)
Инструменты:
-	top / htop — общий обзор в реальном времени.
-	mpstat -P ALL 1 — загрузка по каждому ядру (пакет sysstat).
-	vmstat 1 — резюме CPU и памяти.
-	sar -u 1 3 — логгирование CPU (если включен sysstat).

3. Context Switches (переключения контекста)
Описание:
Процесс переключения CPU между разными задачами. Высокое число — показатель интенсивного многозадачного режима, что может указывать на проблемы (например, lock contention).
Инструменты:
-	vmstat 1 — колонка cs.
-	pidstat -w — переключения по процессам.
-	perf stat — также отображает context switches.

4. Interrupts (прерывания)
Описание:
Количество аппаратных и программных прерываний, обрабатываемых CPU.
-	IRQ (hardware interrupts): сигналы от устройств (сетевых, дисков и т.п.).
-	SoftIRQ (software interrupts): аналог аппаратных, но обработка делегирована ядру.
Инструменты:
-	vmstat -s — статистика по прерываниям.
-	mpstat -I SUM — суммарные прерывания.
-	cat /proc/interrupts — подробный список всех IRQ по ядрам.

5. CPU Time per Process (время CPU по процессам)
Описание:
Сколько процессорного времени потребляет конкретный процесс. Важно при поиске «прожорливых» процессов.
Инструменты:
-	top / htop — колонка %CPU.
-	ps -eo pid,ppid,cmd,%cpu,%mem --sort=-%cpu — вывод процессов с сортировкой по CPU.
-	pidstat -u — метрики CPU по каждому PID.

6. Run Queue Length (длина очереди на CPU)
Описание: Количество процессов, готовых к выполнению, но ожидающих процессор.
Инструменты:
-	vmstat 1 — колонка r.
-	top — в первой строке.
Интерпретация:
Если значение r стабильно больше количества CPU-ядер, это указывает на перегрузку.

7. Steal Time (время "кражи" CPU)
Описание:
Используется в виртуализованных средах. Показывает, сколько времени CPU не доступен для VM, потому что гипервизор отдал его другим VM.
Инструменты:
-	top — st.
-	mpstat — st.

Вспомогательные утилиты для мониторинга CPU
top, htop - Общий обзор процессов и CPU
mpstat - Подробная статистика по ядрам
vmstat - Нагрузка CPU, память, контекстные переключения
pidstat - Метрики CPU по процессам
sar - Историческая статистика
perf - Профилирование и диагностика
dstat - Комбинированный мониторинг ресурсов
glances - Многофункциональный монитор в реальном времени

Основные метрики мониторинга RAM
1. Total Memory (Общий объём памяти)
Описание: Общий объём установленной оперативной памяти в системе.
Инструменты:
-	free -h
-	cat /proc/meminfo (строка MemTotal)

2. Used Memory (Использованная память)
Описание: Количество памяти, уже занятой процессами и системными службами.
Важно: часть этой памяти может быть кэшированной или буферизированной и быть доступной при необходимости.
Инструменты:
-	free -h (колонка used)
-	top или htop (поле Mem)

3. Free Memory (Свободная память)
Описание: Часть памяти, которая полностью свободна и не используется ни процессами, ни системой.
Инструменты:
-	free -h
-	cat /proc/meminfo (строка MemFree)

4. Buffers и Cached (буферы и кэш)
Buffers: Память, зарезервированная для буферизации ввода-вывода, например, для файловых систем.
Cached: Память, используемая под кэш данных (страницы, файлы), которую можно быстро освободить при необходимости.
Инструменты:
-	free -h (колонки buff/cache)
-	cat /proc/meminfo (строки Buffers, Cached, SReclaimable)

5. Available Memory (Доступная память)
Описание: Оценка памяти, которую можно использовать без включения swap. Включает свободную память и ту часть кэша, которая может быть освобождена.
Инструменты:
-	free -h (колонка available)
-	cat /proc/meminfo (строка MemAvailable)

6. Swap Usage (использование подкачки)
Swap Total: весь объём пространства подкачки.
Swap Used: сколько swap уже используется.
Высокое использование swap при достаточной RAM — сигнал о проблемах.
Инструменты:
-	free -h
-	swapon –show
-	vmstat 1 (колонки si — swap in, so — swap out)

7. Page Faults (страничные ошибки)
Major Page Faults: требует чтения данных с диска — медленно.
Minor Page Faults: данные уже в памяти — быстро.
Высокое количество major faults — повод проверить, хватает ли оперативки.
Инструменты:
-	vmstat 1 (колонка majflt)
-	pidstat -r

8. Memory per Process (память по процессам)
Описание: Показывает, сколько памяти использует каждый процесс.
Инструменты:
-	top / htop — колонка %MEM и RES
-	ps aux --sort=-%mem | head — топ прожорливых процессов

9. Slab Cache (кеш ядра)
Описание: Память, зарезервированная ядром под объекты (структуры, дескрипторы и т.п.).
Инструменты:
-	cat /proc/meminfo (строки Slab, SReclaimable, SUnreclaim)

Команды для мониторинга RAM
free -h - Быстрый сводный обзор использования памяти
top / htop - Реальное время, процессы + использование памяти
vmstat 1 - Статистика по памяти и подкачке
cat /proc/meminfo - Полная системная информация о памяти
smem - Более точный учёт памяти по процессам
ps aux --sort=-%mem - Сортировка процессов по использованию памяти.

Метрики, связанные с дисковым пространством
1. Disk Total / Used / Free (всего / занято / свободно)
Описание:
-	Total: общий объём тома;
-	Used: объём занятого пространства;
-	Available: свободное пространство, доступное пользователям.
Инструменты:
-	df -h — обзор по файловым системам;
-	du -sh /path — размер конкретной директории;
-	lsblk — информация о блочных устройствах.
Пример:
$ df -h
Filesystem      Size  Used Avail Use% Mounted on
/dev/sda1        50G   20G   28G  42% /

2. Disk Usage % (процент использования)
Описание: Соотношение занятого к общему пространству — важно для планирования и оповещений.
Пороговые значения:
>80% — повод задуматься о расширении.
>90% — возможны сбои, остановки сервисов.
Инструменты:
-	df -h (колонка Use%);
-	ncdu — визуализация структуры использования.

3. Inodes (число дескрипторов файлов)
Описание: Linux использует inodes для отслеживания файлов. Можно «заполнить» файловую систему, даже если есть свободное место.
Инструменты:
-	df -i — использование inodes;
-	find / -xdev -type f | wc -l — примерный подсчёт файлов.
Важно: особенно критично для каталогов с миллионами маленьких файлов (например, maildir, логовики).

Команда dmesg — это системная утилита в Linux, которая отображает сообщения ядра, то есть события, которые происходят на уровне взаимодействия с оборудованием, драйверами и внутренними подсистемами. Используется при поиске аппаратных проблем, при диагностике ошибок драйверов.

Что показывает dmesg: Команда читает лог кольца буфера ядра (kernel ring buffer) и выводит:
-	Загрузку ядра и модули (boot messages);
-	Обнаружение и инициализацию устройств (диски, сеть, USB);
-	Ошибки ввода-вывода;
-	Системные сбои, сбои драйверов;
-	Информацию о сбоях памяти (например, OOM — Out Of Memory);
-	Проблемы с файловыми системами;
-	Прерывания и сообщения от драйверов.
Как фильтровать вывод dmesg
1. По ключевым словам с grep
- dmesg | grep -i usb        # все сообщения по USB
- dmesg | grep -i error      # ошибки
- dmesg | grep -i nvme       # сообщения о SSD-дисках

2. По времени (-T)
- dmesg -T   # Показывает человекочитаемое время (по умолчанию — сек. с запуска)

3. Только ошибки, предупреждения, критические сбои
- dmesg --level=err,warn,crit,alert,emerg


Основные метрики сетевой активности
1. Throughput (Пропускная способность)
Количество переданных/полученных байт в секунду. Оценивает интенсивность передачи данных.
Единицы: KB/s, MB/s, или bps (бит в секунду).
Инструменты: iftop, nload, bmon, vnstat.

2. Packets per second (PPS)
Число сетевых пакетов, проходящих через интерфейс в секунду. Высокая PPS может указывать на атаки или неэффективный протокол.
Инструменты: sar -n DEV 1, ifstat, ip -s link.

3. Errors (Ошибки передачи)
Количество ошибок при передаче и приёме данных (например, CRC errors, dropped packets). Оценивает качество соединения и драйвера сетевого адаптера.
Инструменты: ip -s link, ethtool -S eth0, netstat -i.

4. Dropped Packets (Потерянные пакеты)
Пакеты, которые не были обработаны (из-за переполнения буфера, фильтрации и т.д.). Влияет на производительность и стабильность соединения.
Инструменты: ip -s link, dmesg, ethtool.

5. Network Latency (Задержка)
Время от отправки до получения пакета. Критично для VoIP, игр, баз данных, чувствительных к задержкам.
Инструменты: ping, mtr, tracepath.

6. Network Connections
Количество и типы активных соединений.
Инструменты: ss -tunap, netstat -tulnp, lsof -i.

7. Bandwidth Utilization
Процент использования доступной полосы пропускания. Влияет на скорость работы приложений и сервисов.
Инструменты: nload, iperf3, bmon.

8. Protocol Distribution
Какие протоколы используются: TCP, UDP, ICMP.
Инструменты: iftop, tcpdump, wireshark, ntop.

III. Полезные утилиты для анализа сети в Linux
ip -s link - Статистика по интерфейсам (байты, пакеты, ошибки)
iftop - В реальном времени показывает активные подключения
nload - Графики входящего и исходящего трафика
vnstat - Долгосрочная статистика трафика по интерфейсам
bmon - Интерактивная визуализация трафика и ошибок
ping - Проверка доступности и задержки
mtr - Объединяет ping и traceroute — маршрут + задержки
iperf3 - Измерение скорости между двумя узлами
tcpdump - Захват сетевых пакетов на уровне интерфейса
ss / netstat - Состояние сетевых соединений и портов
ethtool - Диагностика и настройка Ethernet-интерфейсов

