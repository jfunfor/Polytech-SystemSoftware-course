**Введение в мониторинг в Linux**
- Мониторинг — ключевая часть эксплуатации Linux-систем.
  
/Он позволяет:
- отслеживать производительность и состояние системы в реальном времени;
- выявлять сбои и отклонения от нормы;
- оповещать администраторов о проблемах;
- собирать исторические данные для анализа.


/Мониторинг можно разделить на:
- Инфраструктурный (нагрузка CPU, память, диски, сеть и т.д.);
- Сервисный (доступность и работоспособность приложений и сервисов);
- Прикладной (метрики конкретного приложения: количество запросов, время отклика, ошибки и пр.).

**2. Основные инструменты мониторинга в Linux**
Среди множества инструментов выделяются:
- Prometheus — система сбора метрик.
- Grafana — визуализация метрик.
- Alertmanager — управление алертами.
- Node Exporter — сбор системных метрик.
- Blackbox Exporter — проверка доступности сервисов (ping, http и т.д.).
- cAdvisor — мониторинг контейнеров Docker.
- Netdata, Zabbix, Nagios, Collectd, Telegraf, InfluxDB и др.
В этой лекции основной упор будет на стек Prometheus + Grafana как наиболее современный, мощный и расширяемый.

**Что такое Prometheus?**
Prometheus — это система мониторинга и сбора метрик с временными рядами (time series). Prometheus сам не может напрямую собирать метрики из всех возможных систем (например, из ОС, СУБД или веб-сервера). Экспортеры решают эту проблему. Они получают данные от системы или приложения (например, загрузку CPU, количество соединений к БД и т.д.), преобразуют эти данные в формат метрик Prometheus, предоставляют их по определённому HTTP-эндпоинту, например:
http://localhost:9100/metrics. Prometheus периодически (по scrape_interval) делает HTTP-запрос к этому адресу и сохраняет метрики.
*Ключевые компоненты Prometheus:*
Time Series Database (TSDB) — база данных временных рядов;
PromQL — язык запросов для анализа метрик;
Экспортеры — службы, предоставляющие метрики;
Service Discovery — автоматическое обнаружение целей мониторинга;
Alertmanager — обработка и маршрутизация алертов.
Основные типы экспортеров:
Node Exporter - Метрики CPU, памяти, дисков, сети
Blackbox Exporter - Проверка доступности сервисов (HTTP, ICMP и др.)
cAdvisor - Мониторинг Docker-контейнеров
MySQL Exporter - Метрики баз данных MySQL
Postgres Exporter - Метрики PostgreSQL
NGINX Exporter - Метрики веб-сервера NGINX
Custom Exporter - Пользовательский сбор метрик через HTTP

Экспортеры работают по принципу pull — Prometheus обращается к ним с интервалом и забирает данные.

**Что такое Grafana и как используется в связке с Prometheus?**
Grafana — это инструмент для визуализации метрик, полученных из различных источников, включая Prometheus.
*Как Grafana работает с Prometheus:*
Источник данных в Grafana настраивается на Prometheus. С помощью PromQL задаются запросы к метрикам. Результаты отображаются в виде графиков, панелей, диаграмм, тепловых карт и др. Дашборды позволяют собрать ключевые метрики в одном окне.
Alerting в Grafana позволяет отправлять алерты прямо с графиков (альтернатива Alertmanager).
Grafana делает мониторинг наглядным и доступным для анализа даже не техническими пользователями.
Пример установки Grafana (для Linux Ubuntu):
'''sudo apt-get install -y apt-transport-https
sudo apt-get install -y software-properties-common wget
wget -q -O - https://packages.grafana.com/gpg.key | sudo apt-key add -
sudo add-apt-repository "deb https://packages.grafana.com/oss/deb stable main"
sudo apt-get update
sudo apt-get install grafana
sudo systemctl start grafana-server
sudo systemctl enable grafana-server'''


**5. Как работает роутинг алертов в Prometheus?**
*Роутинг алертов* — это процесс, с помощью которого Alertmanager решает:
-	куда отправить сработавший алерт (Slack, Email, Telegram и т.д.),
-	кому отправить,
-	при каких условиях (фильтры, теги, приоритеты),
-	как группировать и подавлять повторяющиеся оповещения.
Типичная структура основного файла конфигурации Alertmanager:
'''global:
  resolve_timeout: 5m

route:
  receiver: default-receiver
  group_by: ['alertname', 'job']
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 3h

  routes:
    - match:
        severity: critical
      receiver: team-ops
    - match:
        job: mysql
      receiver: dba-team

receivers:
  - name: default-receiver
    email_configs:
      - to: 'admin@example.com'

  - name: team-ops
    slack_configs:
      - channel: '#alerts-critical'

  - name: dba-team
    email_configs:
      - to: 'dba@example.com' '''
*1. global:*
Глобальные настройки (например, время ожидания подтверждения).
*2. route:*
Главная логика маршрутизации:
receiver — куда идут алерты по умолчанию.
group_by — как группировать похожие алерты;
group_wait — сколько ждать перед отправкой группы алертов;
group_interval — как часто повторять уведомление для одной группы;
repeat_interval — как часто повторять тот же алерт.
*3. routes:*
Уточненные правила роутинга.
Если алерт удовлетворяет match, он отправляется в указанный receiver.
*4. receivers:*
Список всех получателей. У каждого указывается способ доставки:
email_configs;
slack_configs;
telegram_configs (через webhook);
webhook_configs и др.

**6. Как тестировать алерты?**
Тестирование алертов позволяет убедиться, что они срабатывают корректно.
Методы тестирования:
-	Promtool — утилита для проверки синтаксиса и логики алертов:
‘’’promtool check rules alert.rules’’’
-	Флаг --web.enable-lifecycle — позволяет перезагружать правила без рестарта Prometheus:
‘’’curl -X POST http://localhost:9090/-/reload’’’
-	Запуск с тестовым конфигом и метриками — можно запустить локальный Prometheus с подставными значениями.
-	Создание временных алертов с низким порогом — например, alert при cpu_usage > 1 для имитации срабатывания.
-	Grafana Alerting — можно протестировать правила прямо в UI через “Test Rule”.

7. Какие есть типы метрик в Prometheus?
Prometheus поддерживает 4 основных типа метрик:
- Counter - Нарастающий счетчик (например, количество запросов); нельзя уменьшать
- Gauge - Значение, которое может увеличиваться и уменьшаться (например, температура, свободная память)
- Histogram - Разбиение значений по корзинам (например, время ответа запросов); включает сумму и количество
- Summary - Похож на Histogram, но с квантилями (например, 95-й процентиль времени ответа)

Пример метрики:
'''http_requests_total{method="GET", handler="/api"} 1234'''

**8. Как избежать перегрузки систем мониторинга?**
Системы мониторинга могут сами становиться причиной проблем, если не соблюдать баланс между количеством метрик, частотой сбора и сложностью запросов.
*Практики для предотвращения перегрузки: *
1. Снижение частоты опроса (scrape_interval):
- 15–30 сек для критичных сервисов;
- 1–2 мин для менее важных.
2. Ограничение количества меток (labels):
- Не создавать метки с высокой кардинальностью (например, user_id, session_id).
3. Агрегация на стороне экспортеров:
- Собирайте обобщённые метрики, а не по каждому объекту.
4. Использование recording rules:
- Сохраняют предвычисленные значения для ускорения запросов.
5. Разделение мониторинга по ролям:
- Отдельные экземпляры Prometheus для разных целей: инфраструктура, приложения и т.д.
6. Мониторинг самого Prometheus:
- Использовать prometheus_tsdb_head_series, prometheus_engine_queries и другие внутренние метрики.


